# üîê Authentication Guide

## Overview

This guide explains how to authenticate with the Londa Rides API. The API uses Firebase Authentication with custom tokens that must be exchanged for ID tokens on the client side.

**‚ö†Ô∏è Important:** The `accessToken` returned by the API is a **Firebase Custom Token**. You must exchange it for an ID token using the Firebase SDK before making authenticated requests.

---

## Complete Authentication Flow

### Step 1: Send OTP üì±

**Endpoint:** `POST /api/v1/registration`

**Request:**
```json
{
  "phone_number": "+264813442530"
}
```

**Response:**
```json
{
  "success": true,
  "message": "OTP sent successfully",
  "data": {
    "sessionInfo": "abc123xyz..."
  },
  "timestamp": "2025-01-01T00:00:00.000000"
}
```

### Step 2: Verify OTP (Get Custom Token) üîê

**Endpoint:** `POST /api/v1/verify-otp`

**Request:**
```json
{
  "phone_number": "+264813442530",
  "otp": "123456",
  "sessionInfo": "abc123xyz..."
}
```

**Response:**
```json
{
  "success": true,
  "message": "OTP verified successfully",
  "data": {
    "accessToken": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user123",
      "phone_number": "+264813442530",
      "email": null,
      "name": null,
      "userType": null,
      "createdAt": "2025-01-01T00:00:00.000000",
      "updatedAt": "2025-01-01T00:00:00.000000"
    }
  },
  "timestamp": "2025-01-01T00:00:00.000000"
}
```

**‚ö†Ô∏è Important:** The `accessToken` is a **Firebase Custom Token**, not an ID token.

### Step 3: Exchange Custom Token for ID Token (Client-Side) üîÑ

**This step MUST be done on the client using Firebase SDK.**

#### React Native Example
```javascript
import auth from '@react-native-firebase/auth';
import * as SecureStore from 'expo-secure-store';

const customToken = response.data.accessToken;
const userCredential = await auth().signInWithCustomToken(customToken);
const idToken = await userCredential.user.getIdToken();
await SecureStore.setItemAsync('auth_token', idToken);
```

#### Flutter Example
```dart
import 'package:firebase_auth/firebase_auth.dart';

final userCredential = await FirebaseAuth.instance.signInWithCustomToken(customToken);
final idToken = await userCredential.user?.getIdToken();
```

### Step 4: Use ID Token üéØ

**Endpoint:** `GET /api/v1/me`

**Headers:**
```
Authorization: Bearer <ID_TOKEN>
```

**Response:**
```json
{
  "success": true,
  "message": "User profile retrieved successfully",
  "data": {
    "id": "user123",
    "phone_number": "+264813442530",
    "email": "user@example.com",
    "name": "John Doe",
    "userType": "student",
    "createdAt": "2025-01-01T00:00:00.000000",
    "updatedAt": "2025-01-01T00:00:00.000000"
  },
  "timestamp": "2025-01-01T00:00:00.000000"
}
```

---

## Current Implementation

### Token Flow
- **Custom Token**: Generated by backend, includes custom claims (`user_type: "user"` or `user_type: "driver"`)
- **ID Token**: Generated by Firebase SDK after exchanging custom token
- **Best Practice**: Mobile apps MUST exchange custom token for ID token using Firebase SDK

### Security
- User IDs are extracted from tokens (not request bodies)
- Role-based access control via custom claims
- Token verification on every protected request

## üì± **Postman Collection Usage**

### **1. Import Collection**
Import the `Londa_Rides_API_Collection.postman_collection.json` file into Postman.

### **2. Set Variables**
- `base_url`: `http://localhost:8000`
- `auth_token`: Will be set automatically after OTP verification

### **3. Test Flow**
1. **Register User**: `POST /api/v1/registration`
2. **Verify OTP**: `POST /api/v1/verify-otp` (use `1234` as OTP)
3. **Get User Data**: `GET /api/v1/me` (uses auto-set token)

## üöÄ **Available Protected Endpoints**

Once you have a token, you can access:

### **User Endpoints:**
- ‚úÖ `GET /api/v1/me` - Get current user data
- ‚úÖ `GET /api/v1/get-rides` - Get user's ride history
- ‚úÖ `POST /api/v1/request-ride` - Request a ride
- ‚úÖ `POST /api/v1/cancel-ride` - Cancel a ride
- ‚úÖ `PUT /api/v1/rate-ride` - Rate a completed ride

### **Driver Endpoints:**
- ‚úÖ `GET /api/v1/driver/profile/{driver_id}` - Get driver profile
- ‚úÖ `POST /api/v1/driver/accept-ride` - Accept ride request
- ‚úÖ `POST /api/v1/driver/start-ride` - Start ride
- ‚úÖ `POST /api/v1/driver/complete-ride` - Complete ride

## üîë **Token Details**

### **Token Format:**
```
Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ6ZFhDSHk3amUzT2FPVkM0cUh3UyIsImlhdCI6MTc2MDkxMDE5OCwiZXhwIjoxNzYxNTE0OTk4fQ.KrqVkkJxyJaIxahy7GK1_X1ejNNhkNjZ9dbZJqaWGTE
```

### **Token Payload:**
```json
{
  "userId": "zdXCHy7je3OaOVC4qHwS",
  "userType": "student",
  "iat": 1760910198,
  "exp": 1761514998
}
```

### **Token Expiry:**
- **Duration**: 7 days
- **Expires**: Automatically after 7 days
- **Refresh**: Get new token by re-verifying OTP

## üéØ **Quick Test Commands**

### **Using curl:**
```bash
# Step 1: Send OTP
curl -X POST http://localhost:8000/api/v1/registration \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "+264813442530"}'

# Step 2: Verify OTP
curl -X POST http://localhost:8000/api/v1/verify-otp \
  -H "Content-Type: application/json" \
  -d '{"phone_number": "+264813442530", "otp": "1234"}'

# Step 3: Use token (replace YOUR_TOKEN_HERE)
curl -X GET http://localhost:8000/api/v1/me \
  -H "Authorization: Bearer YOUR_TOKEN_HERE"
```

### **Using Node.js:**
```javascript
const axios = require('axios');

// Step 1: Send OTP
const otpResponse = await axios.post('http://localhost:8000/api/v1/registration', {
  phone_number: '+264813442530'
});

// Step 2: Verify OTP
const verifyResponse = await axios.post('http://localhost:8000/api/v1/verify-otp', {
  phone_number: '+264813442530',
  otp: '1234'
});

// Extract token
const token = verifyResponse.data.data.token;

// Step 3: Use token
const meResponse = await axios.get('http://localhost:8000/api/v1/me', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

## üéâ **Result**

The authentication system is now fully functional! You can:

1. ‚úÖ **Register users** with phone numbers
2. ‚úÖ **Verify OTP** and get JWT tokens
3. ‚úÖ **Access protected endpoints** using the token
4. ‚úÖ **Get user data** from `/api/v1/me`

The complete authentication flow is working perfectly! üöÄ
